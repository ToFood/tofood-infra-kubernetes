name: Test AWS Connection

on:
  pull_request:
    branches:
      - "main"

jobs:
  test-aws-connection:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ vars.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}

    steps:
      - name: ğŸ¨ Fazer checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸš€ Instalar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16" # Altere para a versÃ£o do Node.js que vocÃª utiliza

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm install aws-sdk

      - name: ğŸ” Exibir variÃ¡veis de ambiente
        run: |
          echo "=== VariÃ¡veis de ambiente ==="
          echo "ğŸŒ AWS_REGION: $AWS_REGION"
          echo "ğŸ”‘ AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID"
          echo "ğŸ”’ AWS_SECRET_ACCESS_KEY: ****"  # Escondendo por seguranÃ§a
          echo "ğŸ” AWS_SESSION_TOKEN: ****"  # Escondendo por seguranÃ§a

      - name: ğŸ”— Testar conexÃ£o com a AWS
        run: |
          node -e "
          const AWS = require('aws-sdk');
          const region = process.env.AWS_REGION;
          const accessKeyId = process.env.AWS_ACCESS_KEY_ID;
          const secretAccessKey = process.env.AWS_SECRET_ACCESS_KEY;
          const sessionToken = process.env.AWS_SESSION_TOKEN;

          console.log('ğŸ” Iniciando teste de conexÃ£o com a AWS...');
          console.log('ğŸŒ RegiÃ£o configurada:', region);

          AWS.config.update({ region, accessKeyId, secretAccessKey, sessionToken });

          async function testConnection() {
            try {
              // Exemplo de teste de conexÃ£o com o serviÃ§o S3
              const s3 = new AWS.S3();
              const result = await s3.listBuckets().promise();
              console.log('âœ¨ğŸ‰ ConexÃ£o bem-sucedida com a AWS! ğŸ‰âœ¨' );
              console.log('ğŸª£ Buckets encontrados:', result.Buckets.map(bucket => bucket.Name).join(', '));
            } catch (error) {
              console.error('âŒ ::error:: Falha ao conectar Ã  AWS:', error.message);
              console.log('âš ï¸ Verifique se as credenciais e a regiÃ£o estÃ£o corretas. ğŸŒ');
              process.exit(1);
            }
          }
          testConnection();
          "
